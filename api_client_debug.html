<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Client Debug Test</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .result { border: 1px solid #ddd; margin: 10px 0; padding: 15px; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; margin: 5px; border-radius: 5px; cursor: pointer; }
        button:hover { background: #0056b3; }
    </style>
</head>
<body>
    <h1>API Client Debug Test</h1>
    <p>This page simulates the frontend API client calls to debug the chat sessions loading issue.</p>

    <div class="result info">
        <h3>Configuration</h3>
        <p><strong>Backend URL:</strong> http://localhost:8000</p>
        <p><strong>Frontend URL:</strong> <span id="current-url"></span></p>
    </div>

    <div id="step1" class="result">
        <h3>Step 1: Test Base API Connectivity</h3>
        <button onclick="testApiConnectivity()">Test API Health</button>
        <div id="step1-result"></div>
    </div>

    <div id="step2" class="result">
        <h3>Step 2: Create Test Session</h3>
        <button onclick="createTestSession()">Create Session</button>
        <div id="step2-result"></div>
    </div>

    <div id="step3" class="result">
        <h3>Step 3: Test GET Chat Sessions (Main Issue)</h3>
        <button onclick="testGetChatSessions()">Test GET /api/chat/sessions</button>
        <div id="step3-result"></div>
    </div>

    <div id="step4" class="result">
        <h3>Step 4: Simulate Frontend API Client Call</h3>
        <button onclick="simulateApiClientCall()">Simulate Frontend API Client</button>
        <div id="step4-result"></div>
    </div>

    <script>
        const BACKEND_URL = 'http://localhost:8000';
        let createdSessionId = null;

        // Set current URL
        document.getElementById('current-url').textContent = window.location.href;

        // Helper function to make API requests like the frontend does
        async function makeApiRequest(endpoint, options = {}) {
            const url = `${BACKEND_URL}${endpoint}`;
            const defaultOptions = {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json',
                },
                ...options
            };

            console.log(`Making API request: ${defaultOptions.method} ${url}`, defaultOptions);

            try {
                const response = await fetch(url, defaultOptions);
                console.log(`Response status: ${response.status} ${response.statusText}`);

                // Log all response headers
                console.log('Response headers:');
                for (const [key, value] of response.headers.entries()) {
                    console.log(`  ${key}: ${value}`);
                }

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error(`HTTP Error ${response.status}: ${errorText}`);
                    return {
                        success: false,
                        error: `HTTP ${response.status}: ${errorText}`,
                        status: response.status
                    };
                }

                const data = await response.json();
                console.log('Response data:', data);

                return {
                    success: true,
                    data: data,
                    status: response.status
                };
            } catch (error) {
                console.error('Request failed:', error);
                return {
                    success: false,
                    error: error.message,
                    status: 0
                };
            }
        }

        async function testApiConnectivity() {
            const resultDiv = document.getElementById('step1-result');
            resultDiv.innerHTML = '<p>Testing API connectivity...</p>';

            const result = await makeApiRequest('/health');
            
            if (result.success) {
                resultDiv.innerHTML = `
                    <div class="success">
                        <h4>✅ API is reachable</h4>
                        <p><strong>Status:</strong> ${result.status}</p>
                        <pre>${JSON.stringify(result.data, null, 2)}</pre>
                    </div>
                `;
            } else {
                resultDiv.innerHTML = `
                    <div class="error">
                        <h4>❌ API connectivity failed</h4>
                        <p><strong>Error:</strong> ${result.error}</p>
                    </div>
                `;
            }
        }

        async function createTestSession() {
            const resultDiv = document.getElementById('step2-result');
            resultDiv.innerHTML = '<p>Creating test session...</p>';

            const result = await makeApiRequest('/api/chat/sessions', {
                method: 'POST',
                body: JSON.stringify({
                    name: 'Frontend Debug Test Session - ' + new Date().toISOString()
                })
            });
            
            if (result.success) {
                createdSessionId = result.data.id;
                resultDiv.innerHTML = `
                    <div class="success">
                        <h4>✅ Test session created</h4>
                        <p><strong>Session ID:</strong> ${result.data.id}</p>
                        <pre>${JSON.stringify(result.data, null, 2)}</pre>
                    </div>
                `;
            } else {
                resultDiv.innerHTML = `
                    <div class="error">
                        <h4>❌ Failed to create session</h4>
                        <p><strong>Error:</strong> ${result.error}</p>
                    </div>
                `;
            }
        }

        async function testGetChatSessions() {
            const resultDiv = document.getElementById('step3-result');
            resultDiv.innerHTML = '<p>Testing GET chat sessions...</p>';

            // Test both with and without project_id parameter
            const results = await Promise.all([
                makeApiRequest('/api/chat/sessions'),
                makeApiRequest('/api/chat/sessions?project_id=test-project')
            ]);

            const [noParamResult, withParamResult] = results;
            
            let html = '';
            
            if (noParamResult.success) {
                html += `
                    <div class="success">
                        <h4>✅ GET /api/chat/sessions (no params)</h4>
                        <p><strong>Number of sessions:</strong> ${noParamResult.data.length}</p>
                        <pre>${JSON.stringify(noParamResult.data, null, 2)}</pre>
                    </div>
                `;
            } else {
                html += `
                    <div class="error">
                        <h4>❌ GET /api/chat/sessions failed</h4>
                        <p><strong>Error:</strong> ${noParamResult.error}</p>
                    </div>
                `;
            }

            if (withParamResult.success) {
                html += `
                    <div class="info">
                        <h4>ℹ️ GET /api/chat/sessions?project_id=test-project</h4>
                        <p><strong>Number of sessions:</strong> ${withParamResult.data.length}</p>
                        <pre>${JSON.stringify(withParamResult.data, null, 2)}</pre>
                    </div>
                `;
            } else {
                html += `
                    <div class="error">
                        <h4>❌ GET /api/chat/sessions with project_id failed</h4>
                        <p><strong>Error:</strong> ${withParamResult.error}</p>
                    </div>
                `;
            }
            
            resultDiv.innerHTML = html;
        }

        async function simulateApiClientCall() {
            const resultDiv = document.getElementById('step4-result');
            resultDiv.innerHTML = '<p>Simulating frontend API client call...</p>';

            // This simulates exactly what the frontend API client does
            class SimulatedApiClient {
                constructor() {
                    this.baseUrl = BACKEND_URL;
                }

                async request(endpoint, options = {}) {
                    const url = `${this.baseUrl}${endpoint}`;
                    const config = {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json',
                        },
                        ...options,
                    };

                    console.log(`SimulatedApiClient: Making request to ${url}`, config);

                    try {
                        const response = await fetch(url, config);
                        console.log(`SimulatedApiClient: Response status: ${response.status}`);

                        if (!response.ok) {
                            const errorText = await response.text();
                            console.error(`SimulatedApiClient: HTTP error: ${response.status} ${errorText}`);
                            return {
                                success: false,
                                error: `HTTP ${response.status}: ${errorText}`,
                            };
                        }

                        const data = await response.json();
                        console.log('SimulatedApiClient: Response data:', data);

                        return {
                            success: true,
                            data: data,
                        };
                    } catch (error) {
                        console.error('SimulatedApiClient: Request failed:', error);
                        return {
                            success: false,
                            error: error.message,
                        };
                    }
                }

                async getChatSessions(projectId) {
                    console.log("SimulatedApiClient.getChatSessions called with projectId:", projectId);
                    const params = projectId ? `?project_id=${projectId}` : '';
                    const endpoint = `/api/chat/sessions${params}`;
                    console.log("SimulatedApiClient.getChatSessions: About to call request with endpoint:", endpoint);
                    console.log("SimulatedApiClient.getChatSessions: Base URL is:", this.baseUrl);
                    console.log("SimulatedApiClient.getChatSessions: Full URL will be:", `${this.baseUrl}${endpoint}`);
                    const result = await this.request(endpoint);
                    console.log("SimulatedApiClient.getChatSessions: Result received:", result);
                    return result;
                }
            }

            const apiClient = new SimulatedApiClient();
            
            // Test both with and without projectId like the frontend does
            const results = await Promise.all([
                apiClient.getChatSessions(),
                apiClient.getChatSessions('test-project'),
                apiClient.getChatSessions(undefined)
            ]);

            const [noParamResult, withProjectResult, undefinedParamResult] = results;
            
            let html = '';
            
            // Result 1: No parameters
            if (noParamResult.success) {
                html += `
                    <div class="success">
                        <h4>✅ SimulatedApiClient.getChatSessions() - No params</h4>
                        <p><strong>Number of sessions:</strong> ${noParamResult.data.length}</p>
                        <p><strong>Is empty array?</strong> ${Array.isArray(noParamResult.data) && noParamResult.data.length === 0 ? 'Yes' : 'No'}</p>
                        <pre>${JSON.stringify(noParamResult.data, null, 2)}</pre>
                    </div>
                `;
            } else {
                html += `
                    <div class="error">
                        <h4>❌ SimulatedApiClient.getChatSessions() failed</h4>
                        <p><strong>Error:</strong> ${noParamResult.error}</p>
                    </div>
                `;
            }

            // Result 2: With project ID
            if (withProjectResult.success) {
                html += `
                    <div class="info">
                        <h4>ℹ️ SimulatedApiClient.getChatSessions('test-project')</h4>
                        <p><strong>Number of sessions:</strong> ${withProjectResult.data.length}</p>
                        <pre>${JSON.stringify(withProjectResult.data, null, 2)}</pre>
                    </div>
                `;
            } else {
                html += `
                    <div class="error">
                        <h4>❌ SimulatedApiClient.getChatSessions('test-project') failed</h4>
                        <p><strong>Error:</strong> ${withProjectResult.error}</p>
                    </div>
                `;
            }

            // Result 3: With undefined parameter (this is what the frontend actually sends)
            if (undefinedParamResult.success) {
                html += `
                    <div class="info">
                        <h4>ℹ️ SimulatedApiClient.getChatSessions(undefined)</h4>
                        <p><strong>Number of sessions:</strong> ${undefinedParamResult.data.length}</p>
                        <p><strong>This matches the frontend call!</strong></p>
                        <pre>${JSON.stringify(undefinedParamResult.data, null, 2)}</pre>
                    </div>
                `;
            } else {
                html += `
                    <div class="error">
                        <h4>❌ SimulatedApiClient.getChatSessions(undefined) failed</h4>
                        <p><strong>Error:</strong> ${undefinedParamResult.error}</p>
                    </div>
                `;
            }
            
            resultDiv.innerHTML = html;
        }

        // Auto-run connectivity test on page load
        window.addEventListener('load', function() {
            setTimeout(testApiConnectivity, 1000);
        });
    </script>
</body>
</html>
